# üóÑÔ∏è Configurar Tablas en Supabase

Para que el sistema guarde los datos de facturas y clientes en Supabase, necesitas crear las tablas en tu base de datos.

## üìã Paso 1: Ejecutar el Script SQL

1. Ve a https://app.supabase.com
2. Selecciona tu proyecto
3. En el men√∫ lateral ‚Üí **SQL Editor**
4. Click en **"New query"**
5. Copia y pega el siguiente SQL:

```sql
-- Create Clients Table
CREATE TABLE IF NOT EXISTS clients (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    name TEXT NOT NULL,
    nif TEXT,
    phone TEXT,
    email TEXT,
    address TEXT,
    city TEXT,
    postal_code TEXT,
    last_purchase TIMESTAMP WITH TIME ZONE
);

-- Create Invoices Table
CREATE TABLE IF NOT EXISTS invoices (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    invoice_id TEXT UNIQUE NOT NULL,
    document_type TEXT,
    date TIMESTAMP WITH TIME ZONE,
    entry_date TEXT,
    delivery_date TEXT,
    client_name TEXT,
    client_nif TEXT,
    client_phone TEXT,
    client_email TEXT,
    client_address TEXT,
    client_city TEXT,
    client_zip TEXT,
    items JSONB,
    subtotal NUMERIC,
    iva_applied BOOLEAN,
    iva_total NUMERIC,
    total_general NUMERIC,
    payment_method TEXT,
    paid_status TEXT,
    pdf_url TEXT
);

-- Disable RLS for simplicity
ALTER TABLE clients DISABLE ROW LEVEL SECURITY;
ALTER TABLE invoices DISABLE ROW LEVEL SECURITY;
```

6. Click **"Run"** (o presiona Ctrl+Enter / Cmd+Enter)

## ‚úÖ Verificar que Funcion√≥

1. En el men√∫ lateral ‚Üí **Table Editor**
2. Deber√≠as ver dos tablas:
   - **clients** (con columnas: id, created_at, name, nif, phone, email, address, city, postal_code, last_purchase)
   - **invoices** (con columnas: id, created_at, invoice_id, document_type, date, entry_date, delivery_date, client_name, etc.)

## üß™ Probar el Sistema Completo

Despu√©s de crear las tablas:

1. Abre `index.html` en tu navegador
2. Genera una factura de prueba
3. Deber√≠as ver estos mensajes en orden:
   - ‚úÖ "Generant factura..."
   - ‚úÖ "Pujant PDF a Supabase..."
   - ‚úÖ "Enviant correu..."
   - ‚úÖ "Guardant dades a Supabase..."
   - ‚úÖ "‚úì Factura generada, guardada i enviada correctament"

4. **Verifica en Supabase:**
   - **Table Editor ‚Üí invoices** ‚Üí Deber√≠as ver la factura guardada
   - **Table Editor ‚Üí clients** ‚Üí Deber√≠as ver el cliente guardado
   - **Storage ‚Üí invoices** ‚Üí Deber√≠as ver el PDF

5. **Verifica el email:**
   - Revisa tu bandeja de entrada
   - Click en el link de descarga
   - El PDF deber√≠a descargarse correctamente

## üìä Qu√© se Guarda

### Tabla `invoices`
- N√∫mero de factura (C0001, P0001, etc.)
- Tipo de documento (Comanda/Pressupost)
- Fechas (entrada, entrega)
- Datos del cliente
- Productos (JSON)
- Totales (subtotal, IVA, total)
- M√©todo de pago y estado
- **URL del PDF en Supabase Storage**

### Tabla `clients`
- Nombre
- NIF/DNI
- Tel√©fono
- Email
- Direcci√≥n completa
- √öltima compra

## üîÑ Actualizaci√≥n Autom√°tica de Clientes

El sistema es inteligente:
- Si el cliente **ya existe** (mismo tel√©fono o email) ‚Üí **Actualiza** sus datos
- Si el cliente **es nuevo** ‚Üí **Crea** un nuevo registro

## ‚úÖ Listo

Una vez ejecutado el SQL, el sistema guardar√° autom√°ticamente:
1. ‚úÖ PDF en Supabase Storage
2. ‚úÖ Factura en tabla `invoices`
3. ‚úÖ Cliente en tabla `clients`
4. ‚úÖ Email enviado con link de descarga
5. ‚úÖ Copia local en localStorage (backup)

---

**Ejecuta el SQL ahora y prueba generando una factura. ¬°Todo deber√≠a funcionar perfectamente!**
